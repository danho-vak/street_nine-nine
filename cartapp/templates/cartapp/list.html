{% extends 'base.html' %}
{% load static %}
{% load imagekit %}
{% block content %}

<table class="table table-borderless">
    <tr>
        <th></th>
        <th>상품 이미지</th>
        <th>상품 정보</th>
        <th>가격/수량</th>
        <th>총 계</th>
    </tr>
    {% for item in target_cart.cart_item.all %}
    <tr>
        <td rowspan="2">
            <input type="checkbox" name="cart_item_checkbox" id="cart_item_checkbox_{{ item.pk }}" value="{{ item.pk }}">
        </td>
        <td rowspan="2"><img src="{{ item.product.product_thumbnails.first.p_thumbnail.url }}" width="100" height="100"></td>
        <td>
            <a href="{% url 'productapp:detail' pk=item.product.pk%}">
                {{ item.product.product_title }}
            </a>
        </td>
        <td>{{ item.product.product_sale_price }}</td>
        <td>{{ item.price_total }}</td>
    </tr>
    <tr>
        <td>{{ item.product_option.p_product_option_class_1 }} : {{ item.product_option.p_product_option_class_2 }}</td>
        <td> 수량 : <input type="number" id="cart_item_quantity_{{ item.pk }}" value="{{ item.quantity }}"></td>
    </tr>
    {% endfor %}
</table>
<div class="text-right">
    <button class="btn btn-secondary" onclick="deleteCartItem();">상품 삭제</button>
    <button class="btn btn-primary">구매하기</button>
</div>

<script>
    // checkbox 선택된 값이 있는지 확인
    function isChecked(){
        checked_item = $('input[name=cart_item_checkbox]:checked');

        if (checked_item.length > 0) {
            return checked_item;
        } else {
            return false;
        }
    }

    function deleteCartItem(){
        checked_item = isChecked();
        if (checked_item) {
            var result = confirm('해당 상품을 장바구니에서 제외할까요?');
            var cart_pk = $('#target_cart').val()
            var cart_item_list = []

            if (result) {
                for (var i=0; i<checked_item.length; i++) {
                    cart_item_list.push(checked_item[i].value);
                }

                $.post('{% url 'cartapp:delete' cart_pk=target_cart.pk %}',
                    {
                        'csrfmiddlewaretoken' : csrftoken,
                        'cart_item_list' : cart_item_list
                    }, function() {
                        alert('삭제완료!');
                        location.reload();
                });
            }
        } else {
            alert('상품을 선택해주세요!');
        }
    }
</script>
{% endblock %}